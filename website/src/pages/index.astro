---
import Layout from '../layouts/Layout.astro';
import oddsData from '../data/odds.json';

const matches = oddsData.matches;
const bookmakers = oddsData.bookmakers;

// Group matches by league
const matchesByLeague = matches.reduce((acc, match) => {
  if (!acc[match.league]) {
    acc[match.league] = [];
  }
  acc[match.league].push(match);
  return acc;
}, {} as Record<string, typeof matches>);

const leagues = Object.keys(matchesByLeague).sort();
---

<Layout title="You Bet - Football Odds">
  <h2>Upcoming Matches</h2>

  <div class="filter-bar">
    <select id="league-filter">
      <option value="">All Leagues</option>
      {leagues.map(league => (
        <option value={league}>{league}</option>
      ))}
    </select>
  </div>

  {matches.map(match => {
    const kickoff = new Date(match.commence_time);
    const kickoffStr = kickoff.toLocaleString('en-GB', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });

    return (
      <div class="match-card" data-league={match.league}>
        <div class="match-header">
          <div class="match-teams">
            {match.home_team} vs {match.away_team}
          </div>
          <div class="match-meta">
            {match.league} | {kickoffStr}
          </div>
        </div>

        <div class="odds-grid">
          <table class="odds-summary">
            <thead>
              <tr>
                <th></th>
                <th>Home</th>
                <th>Draw</th>
                <th>Away</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="row-label">Median</td>
                <td>
                  <span class="odds">{match.probability.home?.median_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.home ? (match.probability.home.median_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
                <td>
                  <span class="odds">{match.probability.draw?.median_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.draw ? (match.probability.draw.median_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
                <td>
                  <span class="odds">{match.probability.away?.median_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.away ? (match.probability.away.median_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
              </tr>
              <tr>
                <td class="row-label">Mean</td>
                <td>
                  <span class="odds">{match.probability.home?.mean_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.home ? (match.probability.home.mean_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
                <td>
                  <span class="odds">{match.probability.draw?.mean_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.draw ? (match.probability.draw.mean_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
                <td>
                  <span class="odds">{match.probability.away?.mean_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.away ? (match.probability.away.mean_prob * 100).toFixed(0) + '%' : '-'})</span>
                </td>
              </tr>
              <tr class="best-row">
                <td class="row-label">Best</td>
                <td>
                  <span class="odds best">{match.probability.home?.best_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.home ? (match.probability.home.best_prob * 100).toFixed(0) + '%' : '-'})</span>
                  <span class="bookmaker">{match.probability.home?.best_bookmaker || ''}</span>
                </td>
                <td>
                  <span class="odds best">{match.probability.draw?.best_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.draw ? (match.probability.draw.best_prob * 100).toFixed(0) + '%' : '-'})</span>
                  <span class="bookmaker">{match.probability.draw?.best_bookmaker || ''}</span>
                </td>
                <td>
                  <span class="odds best">{match.probability.away?.best_odds?.toFixed(2) || '-'}</span>
                  <span class="prob">({match.probability.away ? (match.probability.away.best_prob * 100).toFixed(0) + '%' : '-'})</span>
                  <span class="bookmaker">{match.probability.away?.best_bookmaker || ''}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <details>
          <summary>View all {match.odds.length} bookmakers</summary>
          <div class="odds-table-container">
            <table>
              <thead>
                <tr>
                  <th>Bookmaker</th>
                  <th>Home</th>
                  <th>Draw</th>
                  <th>Away</th>
                </tr>
              </thead>
              <tbody>
                {match.odds.map(o => (
                  <tr>
                    <td>{o.bookmaker}</td>
                    <td class:list={["odds-value", { best: o.home === match.best_odds.home }]}>
                      {o.home?.toFixed(2) || '-'}
                    </td>
                    <td class:list={["odds-value", { best: o.draw === match.best_odds.draw }]}>
                      {o.draw?.toFixed(2) || '-'}
                    </td>
                    <td class:list={["odds-value", { best: o.away === match.best_odds.away }]}>
                      {o.away?.toFixed(2) || '-'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </details>
      </div>
    );
  })}
</Layout>

<style>
  h2 {
    margin-bottom: 1.5rem;
  }

  .odds-grid {
    margin-bottom: 1rem;
    overflow-x: auto;
  }

  .odds-summary {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .odds-summary th,
  .odds-summary td {
    padding: 0.5rem 0.75rem;
    text-align: center;
    border-bottom: 1px solid var(--accent);
  }

  .odds-summary th {
    background: var(--accent);
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  .odds-summary th:first-child,
  .odds-summary td.row-label {
    text-align: left;
    width: 80px;
  }

  .odds-summary td.row-label {
    font-weight: 600;
    color: var(--text-dim);
    font-size: 0.75rem;
  }

  .odds-summary .odds {
    font-weight: 700;
    font-family: monospace;
    margin-right: 0.25rem;
  }

  .odds-summary .odds.best {
    color: var(--green);
  }

  .odds-summary .prob {
    color: var(--text-dim);
    font-size: 0.75rem;
  }

  .odds-summary .bookmaker {
    display: block;
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 0.125rem;
  }

  .odds-summary .best-row {
    background: rgba(74, 222, 128, 0.05);
  }

  details {
    margin-top: 1rem;
  }

  summary {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 0.875rem;
  }

  summary:hover {
    color: var(--text);
  }

  details[open] summary {
    margin-bottom: 0.5rem;
  }
</style>

<script>
  const filter = document.getElementById('league-filter') as HTMLSelectElement;
  const cards = document.querySelectorAll('.match-card');

  filter?.addEventListener('change', () => {
    const selected = filter.value;
    cards.forEach(card => {
      const league = card.getAttribute('data-league');
      if (!selected || league === selected) {
        (card as HTMLElement).style.display = 'block';
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });
  });
</script>
