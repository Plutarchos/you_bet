---
import Layout from '../layouts/Layout.astro';
import oddsData from '../data/odds.json';

const matches = oddsData.matches;
const bookmakers = oddsData.bookmakers;

// Group matches by league
const matchesByLeague = matches.reduce((acc, match) => {
  if (!acc[match.league]) {
    acc[match.league] = [];
  }
  acc[match.league].push(match);
  return acc;
}, {} as Record<string, typeof matches>);

const leagues = Object.keys(matchesByLeague).sort();
---

<Layout title="You Bet - Football Odds">
  <h2>Upcoming Matches</h2>

  <div class="filter-bar">
    <select id="league-filter">
      <option value="">All Leagues</option>
      {leagues.map(league => (
        <option value={league}>{league}</option>
      ))}
    </select>
  </div>

  {matches.map(match => {
    const kickoff = new Date(match.commence_time);
    const kickoffStr = kickoff.toLocaleString('en-GB', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      hour: '2-digit',
      minute: '2-digit'
    });

    return (
      <div class="match-card" data-league={match.league}>
        <div class="match-header">
          <div class="match-teams">
            {match.home_team} vs {match.away_team}
          </div>
          <div class="match-meta">
            {match.league} | {kickoffStr}
          </div>
        </div>

        <div class="probability-grid">
          <div class="prob-box">
            <div class="prob-header">Home</div>
            <div class="prob-median">{match.probability.home ? (match.probability.home.median * 100).toFixed(1) + '%' : '-'}</div>
            <div class="prob-details">
              <span class="best-odds">{match.probability.home?.best_odds?.toFixed(2) || '-'}</span>
              <span class="bookmaker">{match.probability.home?.best_bookmaker || ''}</span>
            </div>
            <div class="value-diff" class:list={[{ positive: match.probability.home?.diff_from_median > 0.02 }]}>
              +{match.probability.home ? (match.probability.home.diff_from_median * 100).toFixed(1) : '0'}%
            </div>
          </div>
          <div class="prob-box">
            <div class="prob-header">Draw</div>
            <div class="prob-median">{match.probability.draw ? (match.probability.draw.median * 100).toFixed(1) + '%' : '-'}</div>
            <div class="prob-details">
              <span class="best-odds">{match.probability.draw?.best_odds?.toFixed(2) || '-'}</span>
              <span class="bookmaker">{match.probability.draw?.best_bookmaker || ''}</span>
            </div>
            <div class="value-diff" class:list={[{ positive: match.probability.draw?.diff_from_median > 0.02 }]}>
              +{match.probability.draw ? (match.probability.draw.diff_from_median * 100).toFixed(1) : '0'}%
            </div>
          </div>
          <div class="prob-box">
            <div class="prob-header">Away</div>
            <div class="prob-median">{match.probability.away ? (match.probability.away.median * 100).toFixed(1) + '%' : '-'}</div>
            <div class="prob-details">
              <span class="best-odds">{match.probability.away?.best_odds?.toFixed(2) || '-'}</span>
              <span class="bookmaker">{match.probability.away?.best_bookmaker || ''}</span>
            </div>
            <div class="value-diff" class:list={[{ positive: match.probability.away?.diff_from_median > 0.02 }]}>
              +{match.probability.away ? (match.probability.away.diff_from_median * 100).toFixed(1) : '0'}%
            </div>
          </div>
        </div>

        <details>
          <summary>View all {match.odds.length} bookmakers</summary>
          <div class="odds-table-container">
            <table>
              <thead>
                <tr>
                  <th>Bookmaker</th>
                  <th>Home</th>
                  <th>Draw</th>
                  <th>Away</th>
                </tr>
              </thead>
              <tbody>
                {match.odds.map(o => (
                  <tr>
                    <td>{o.bookmaker}</td>
                    <td class:list={["odds-value", { best: o.home === match.best_odds.home }]}>
                      {o.home?.toFixed(2) || '-'}
                    </td>
                    <td class:list={["odds-value", { best: o.draw === match.best_odds.draw }]}>
                      {o.draw?.toFixed(2) || '-'}
                    </td>
                    <td class:list={["odds-value", { best: o.away === match.best_odds.away }]}>
                      {o.away?.toFixed(2) || '-'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </details>
      </div>
    );
  })}
</Layout>

<style>
  h2 {
    margin-bottom: 1.5rem;
  }

  .probability-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .prob-box {
    background: var(--accent);
    padding: 0.75rem;
    border-radius: 6px;
    text-align: center;
  }

  .prob-header {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    margin-bottom: 0.25rem;
  }

  .prob-median {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
  }

  .prob-details {
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }

  .prob-details .best-odds {
    color: var(--green);
    font-weight: 600;
    margin-right: 0.5rem;
  }

  .prob-details .bookmaker {
    color: var(--text-dim);
  }

  .value-diff {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 0.25rem;
  }

  .value-diff.positive {
    color: var(--green);
    font-weight: 600;
  }

  details {
    margin-top: 1rem;
  }

  summary {
    cursor: pointer;
    color: var(--text-dim);
    font-size: 0.875rem;
  }

  summary:hover {
    color: var(--text);
  }

  details[open] summary {
    margin-bottom: 0.5rem;
  }

  @media (max-width: 480px) {
    .probability-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const filter = document.getElementById('league-filter') as HTMLSelectElement;
  const cards = document.querySelectorAll('.match-card');

  filter?.addEventListener('change', () => {
    const selected = filter.value;
    cards.forEach(card => {
      const league = card.getAttribute('data-league');
      if (!selected || league === selected) {
        (card as HTMLElement).style.display = 'block';
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });
  });
</script>
